<html>
<!-- Open it with --allow-file-access-from-files -->
<script>
WebInspector = {};
WebInspector.UIString = function(string, vararg) {
    if (vararg)
        return string + " : " + vararg;
    else
        return string;
}
</script>
<script src="HeapSnapshot.js"></script>
<script src="JSHeapSnapshot.js"></script>
<script>
DummyProgress = function(dispatcher)
{
  this._dispatcher = dispatcher;
}

DummyProgress.prototype = {
  /**
   * @param{string} status
   */
  updateStatus: function(status)
  {
    console.log(WebInspector.UIString(status));
  },

  /**
   * @param{string} title
   * @param{number} value
   * @param{number} total
   */
  updateProgress: function(title, value, total)
  {
    var percentValue = ((total ? (value / total) : 0) * 100).toFixed(0);
    console.log(WebInspector.UIString(title, percentValue));
  }
}

var xmlHttp;
var snapshot;

function checkStatus(){
  if ((xmlHttp.readyState === 4) && (xmlHttp.status === 200 || xmlHttp.status === 0)) {
    var loaded = JSON.parse(xmlHttp.responseText);
    snapshot = new WebInspector.JSHeapSnapshot(loaded, new DummyProgress());

    var matchSlow = true;
    if (snapshot._dominatorsTree.length !== snapshot._dominatorsTree_GD2_slow.length) {
      matchSlow = false;
    } else {
      for (var i = 0; i < snapshot._dominatorsTree.length; ++i) {
        if (snapshot._dominatorsTree[i] !== snapshot._dominatorsTree_GD2_slow[i]) {
          matchSlow = false;
          break;
        }
      }
    }

    var matchFast = true;
    if (snapshot._dominatorsTree.length !== snapshot._dominatorsTree_GD2.length) {
      matchFast = false;
    } else {
      for (var i = 0; i < snapshot._dominatorsTree.length; ++i) {
        if (snapshot._dominatorsTree[i] !== snapshot._dominatorsTree_GD2[i]) {
          matchFast = false;
          break;
        }
      }
    }

    var matchSlowFast = true;
    if (snapshot._dominatorsTree_GD2.length !== snapshot._dominatorsTree_GD2_slow.length) {
      matchSlowFast = false;
    } else {
      for (var i = 0; i < snapshot._dominatorsTree.length; ++i) {
        if (snapshot._dominatorsTree_GD2[i] !== snapshot._dominatorsTree_GD2_slow[i]) {
          matchSlowFast = false;
          break;
        }
      }
    }

    // Check the results.
    if (matchSlow) {
      console.log("Slow - OK");
      console.log(snapshot._dominatorsTree);
    } else {
      console.log("Slow - NG");
      console.log(snapshot._dominatorsTree_GD2_slow);
      console.log(snapshot._dominatorsTree);
    }
    if (matchFast) {
      console.log("Fast - OK");
      console.log(snapshot._dominatorsTree);
    } else {
      console.log("Fast - NG");
      console.log(snapshot._dominatorsTree_GD2);
      console.log(snapshot._dominatorsTree);
    }

    if (matchSlowFast) {
      console.log("FYI: Slow === Fast");
      console.log(snapshot._dominatorsTree_GD2);
    } else {
      console.log("FYI: Slow !== Fast");
      console.log(snapshot._dominatorsTree_GD2);
      console.log(snapshot._dominatorsTree_GD2_slow);
    }
  } else {
    setTimeout(checkStatus, 1000);
  }
}

function loadText(){
  xmlHttp = new XMLHttpRequest();
//  xmlHttp.open("GET", "file:////usr/local/google/home/dmikurube/work/dominator/doublelink-30000.heapsnapshot" + '?' + (new Date().getTime()), true);
  xmlHttp.open("GET", "file:////usr/local/google/home/dmikurube/work/dominator/small-raw.heapsnapshot" + '?' + (new Date().getTime()), true);
//  xmlHttp.open("GET", "file:////usr/local/google/home/dmikurube/work/dominator/sample.heapsnapshot" + '?' + (new Date().getTime()), true);
//  xmlHttp.open("GET", "file:////usr/local/google/home/dmikurube/work/dominator/mozilla.heapsnapshot" + '?' + (new Date().getTime()), true);
//  xmlHttp.open("GET", "file:////usr/local/google/home/dmikurube/work/dominator/mini.heapsnapshot" + '?' + (new Date().getTime()), true);
  xmlHttp.send(null);
  setTimeout(checkStatus, 1000);
}

</script>

<button onclick="loadText()">Push</button>

</html>
